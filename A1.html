<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Scolaire Afrique</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        /* Styles identiques à l'original */
        :root {
            --primary-color: #4CAF50;
            --primary-dark-color: #388E3C;
            --secondary-color: #FFC107;
            --accent-color: #2196F3;
            --background-color: #f4f7f6;
            --surface-color: #ffffff;
            --text-color: #333333;
            --light-text-color: #757575;
            --border-color: #e0e0e0;
            --success-color: #4CAF50;
            --error-color: #f44336;
            --info-color: #2196F3;
            --warning-color: #FF9800;
            --header-height: 60px;
            --sidebar-width: 220px;
        }
        body.dark-mode {
            --primary-color: #66BB6A;
            --primary-dark-color: #4CAF50;
            --secondary-color: #FFD54F;
            --accent-color: #64B5F6;
            --background-color: #2c2c2c;
            --surface-color: #3a3a3a;
            --text-color: #e0e0e0;
            --light-text-color: #aaaaaa;
            --border-color: #555555;
            --success-color: #81C784;
            --error-color: #EF5350;
            --info-color: #42A5F5;
            --warning-color: #FFCA28;
        }
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: var(--header-height);
            box-sizing: border-box;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
        }
        .header-left h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
        }
        .header-logo {
            height: 40px;
            width: 40px;
            margin-right: 15px;
            border-radius: 50%;
            object-fit: contain;
            background-color: white;
            padding: 2px;
        }
        .school-info {
            font-size: 0.9em;
            margin-left: 20px;
        }
        .school-info p {
            margin: 2px 0;
        }
        .school-info strong {
            font-weight: 700;
        }
        .year-selector {
            margin-right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .year-selector label {
            font-weight: 500;
            white-space: nowrap;
        }
        .year-selector select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-5.4H18.2c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.7c0%204.6%201.8%208.9%205.4%2012.5l128.8%20127.9c3.6%203.6%207.8%205.4%2012.5%205.4s8.9-1.8%2012.5-5.4L287%2095.2c3.6-3.6%205.4-7.8%205.4-12.5%200-4.6-1.8-8.9-5.4-12.5z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .year-selector select option {
            color: var(--text-color);
            background-color: var(--surface-color);
        }
        .main-content {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--surface-color);
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            left: 0;
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
            border-left: 5px solid transparent;
        }
        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background-color: var(--primary-color);
            color: white;
            border-left-color: var(--accent-color);
        }
        .sidebar nav ul li a i {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .sidebar-bottom {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            transition: border-color 0.3s;
        }
        .language-selector, .theme-switch-container {
            padding: 10px 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .language-selector label, .theme-switch-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .language-selector select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            background-color: var(--background-color);
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            color: var(--text-color);
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        .content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - var(--header-height));
        }
        .content-section {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        h2 {
            color: var(--primary-dark-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2em;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.3s, border-color 0.3s;
        }
        h2 i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        h3 {
            color: var(--accent-color);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            transition: color 0.3s;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--light-text-color);
            font-size: 0.95em;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 24px);
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s, background-color 0.3s, color 0.3s;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
            outline: none;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .radio-group div {
            display: flex;
            align-items: center;
        }
        .radio-group input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .radio-group input[type="radio"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .radio-group input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            background-color: white;
            border-radius: 50%;
            margin: 2px;
        }
        .radio-group label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
            color: var(--text-color);
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .checkbox-group div {
            display: flex;
            align-items: center;
        }
        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .checkbox-group input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .checkbox-group input[type="checkbox"]:checked::before {
            content: '\2713';
            display: block;
            text-align: center;
            color: white;
            font-size: 14px;
            line-height: 16px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
            color: var(--text-color);
        }
        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn i {
            margin-right: 8px;
        }
        .btn:hover {
            background-color: var(--primary-dark-color);
            transform: translateY(-2px);
        }
        .btn-secondary { background-color: var(--accent-color); }
        .btn-secondary:hover { background-color: #1976D2; }
        .btn-danger { background-color: var(--error-color); }
        .btn-danger:hover { background-color: #D32F2F; }
        .btn-small { padding: 8px 15px; font-size: 0.9em; }
        .btn-small i { margin-right: 0; }
        .message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: none;
            animation: fadein 0.5s;
        }
        .message.success { background-color: #e8f5e9; color: var(--success-color); border: 1px solid var(--success-color); }
        .message.error { background-color: #ffebee; color: var(--error-color); border: 1px solid var(--error-color); }
        .message.info { background-color: #e3f2fd; color: var(--info-color); border: 1px solid var(--info-color); }
        body.dark-mode .message.success { background-color: #388E3C; color: #DCEDC8; border-color: #81C784; }
        body.dark-mode .message.error { background-color: #D32F2F; color: #FFCDD2; border-color: #EF9A9A; }
        body.dark-mode .message.info { background-color: #1976D2; color: #BBDEFB; border-color: #64B5F6; }
        @keyframes fadein {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--surface-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        table th, table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: border-color 0.3s;
        }
        table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        table tbody tr:nth-child(even) { background-color: var(--background-color); transition: background-color 0.3s; }
        table tbody tr:hover { background-color: #eef; cursor: pointer; }
        body.dark-mode table tbody tr:nth-child(even) { background-color: #3f3f3f; }
        body.dark-mode table tbody tr:hover { background-color: #4a4a4a; }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }
        .pagination button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .pagination button:hover:not(:disabled) { background-color: var(--primary-dark-color); }
        .pagination button:disabled { background-color: #cccccc; cursor: not-allowed; }
        body.dark-mode .pagination button:disabled { background-color: #555555; }
        .pagination span { font-weight: 500; color: var(--text-color); transition: color 0.3s; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-top: 30px; }
        .stat-card {
            background-color: var(--accent-color);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
        .stat-card.students { background-color: var(--primary-color); }
        .stat-card.collected { background-color: #FF9800; }
        .stat-card.remaining { background-color: var(--error-color); }
        body.dark-mode .stat-card.students { background-color: var(--primary-dark-color); }
        body.dark-mode .stat-card.collected { background-color: #F57C00; }
        body.dark-mode .stat-card.remaining { background-color: #D32F2F; }
        .stat-card h3 { color: white; margin-top: 0; margin-bottom: 10px; font-size: 1.3em; }
        .stat-card p { font-size: 2.5em; font-weight: 700; margin: 0; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: fadeInModal 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        @keyframes fadeInModal { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-close-btn { color: var(--light-text-color); position: absolute; top: 15px; right: 25px; font-size: 30px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .modal-close-btn:hover, .modal-close-btn:focus { color: var(--error-color); text-decoration: none; cursor: pointer; }
        .modal h2 { color: var(--primary-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-footer { margin-top: 30px; text-align: right; border-top: 1px solid var(--border-color); padding-top: 20px; }
        #settings-section .form-group { border-bottom: 1px dashed var(--border-color); padding-bottom: 20px; margin-bottom: 20px; transition: border-color 0.3s; }
        #settings-section .form-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .logo-upload-preview { display: flex; align-items: center; gap: 20px; margin-top: 15px; }
        .logo-upload-preview img { max-width: 100px; max-height: 100px; border-radius: 5px; border: 1px solid var(--border-color); object-fit: contain; background-color: var(--background-color); transition: border-color 0.3s, background-color 0.3s; }
        .logo-upload-preview .placeholder {
            width: 100px;
            height: 100px;
            border: 1px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--light-text-color);
            font-size: 0.9em;
            text-align: center;
            border-radius: 5px;
            background-color: var(--background-color);
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        .drop-zone {
            border: 2px dashed var(--accent-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            color: var(--light-text-color);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            position: relative;
            overflow: hidden;
            background-color: var(--background-color);
        }
        .drop-zone:hover { background-color: #eef; border-color: var(--primary-color); }
        body.dark-mode .drop-zone:hover { background-color: #4a4a4a; border-color: var(--primary-dark-color); }
        .drop-zone input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        @media print {
            body, body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; box-shadow: none !important; background-color: transparent !important; margin: 0; padding: 0; border: none; }
            @page { size: A4; margin: 15mm; }
            @page receipt-layout { size: A5 landscape; margin: 10mm; }
            .printable-area.receipt-half-a4 { page: receipt-layout; position: absolute; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; font-family: 'Roboto', sans-serif; color: #000; background-color: #fff !important; font-size: 10pt; }
            .printable-area p { margin: 2px 0; }
            .printable-area .label { font-weight: normal; }
            .printable-area .dashed-line { display: block; position: absolute; bottom: -5mm; left: 5%; width: 90%; border: none; border-top: 1.5px dashed #000; page-break-after: always; }
            .receipt { padding-bottom: 10mm; }
            .receipt .receipt-header-top { display: flex; align-items: flex-start; margin-bottom: 10mm; position: relative; }
            .receipt .receipt-logo-container { width: 40mm; height: 30mm; position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center; }
            .receipt .receipt-logo { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 0; }
            .receipt .receipt-logo.placeholder { border: 1px solid #000; font-size: 0.7em; text-align: center; line-height: normal; padding: 5px; box-sizing: border-box; }
            .receipt .receipt-school-details { margin-left: 45mm; text-align: left; flex-grow: 1; font-size: 1.0em; }
            .receipt .receipt-school-name { font-size: 1.4em; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; text-decoration: underline; color: #000; }
            .receipt .receipt-school-contact { font-size: 0.8em; color: #333; white-space: nowrap; }
            .receipt .receipt-divider-line { border: none; border-top: 1px solid #000; margin: 10mm 0; }
            .receipt .receipt-content-grid { display: grid; grid-template-columns: 2fr 2fr; gap: 5mm; margin-bottom: 10mm; }
            .receipt .receipt-left-column p, .receipt .receipt-center-column p, .receipt .receipt-bottom-grid p { margin: 3px 0; }
            .receipt .receipt-left-column .label { min-width: 100px; display: inline-block; }
            .receipt .payment-date { font-weight: bold; text-align: center; margin-bottom: 3px !important; }
            .receipt .payment-date-value { text-align: center; font-weight: bold; font-size: 1.0em; margin-top: 0 !important; margin-bottom: 10mm !important; }
            .receipt .amount-box { border: 1px solid #000; padding: 5px 10px; margin-bottom: 5mm; display: flex; flex-direction: column; align-items: center; }
            .receipt .amount-box .label { font-size: 0.8em; margin-bottom: 2px; text-align: center; }
            .receipt .amount-box .amount-value { font-size: 1.2em; font-weight: bold; text-align: center; color: #000; }
            .receipt .photo-box { width: 35mm; height: 40mm; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.9em; color: #555; margin-left: auto; padding: 5px; }
            .receipt .photo-box i { font-size: 2.5em; color: #888; margin-bottom: 5px; }
            .receipt .photo-placeholder { font-size: 0.7em; line-height: normal; }
            .receipt .receipt-bottom-grid { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15mm; }
            .receipt .cashier-info { flex-basis: 45%; text-align: center; }
            .receipt .cashier-info .cashier-name { margin-top: 15mm; font-weight: bold; text-decoration: underline; margin-bottom: 5px; }
            .receipt .cashier-info .signature-line { font-size: 0.8em; }
            .receipt .school-stamp-area { width: 40mm; height: 30mm; border: 1px solid #000; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; color: #555; text-transform: uppercase; flex-shrink: 0; margin-left: auto; text-align: center; }
            .receipt .receipt-note { font-size: 0.75em; text-align: center; margin-top: 10mm; margin-bottom: 5mm; color: #333; }
            .printable-area.sheet { width: 100%; min-height: 297mm; padding: 15mm 20mm; box-sizing: border-box; font-family: 'Roboto', sans-serif; color: #000; background-color: #fff !important; font-size: 11pt; }
            .sheet .sheet-header { text-align: center; position: relative; margin-bottom: 15mm; }
            .sheet .sheet-logo { height: 70px; width: 70px; object-fit: contain; position: absolute; left: 0; top: 0; border-radius: 0; padding: 0; }
            .sheet .sheet-logo.placeholder { border: 1px dashed #ccc; font-size: 0.8em; line-height: 70px; display: block !important; }
            .sheet .sheet-school-name { font-size: 1.8em; margin-bottom: 5px; color: #333; text-transform: uppercase; }
            .sheet .sheet-school-contact { font-size: 0.9em; margin-top: 0; color: #555; }
            .sheet .sheet-title-heading { font-size: 1.5em; margin-top: 20px; color: #000; text-decoration: underline; }
            .sheet .sheet-info-line { display: flex; justify-content: center; margin-top: 15px; font-size: 1em; gap: 20px; }
            .sheet .sheet-info-line p { margin: 0; }
            .sheet hr { border: none; border-top: 1px solid #ddd; margin: 20px 0; }
            .sheet .sheet-section h5 { margin-bottom: 5px; font-size: 1.1em; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            .sheet .sheet-section p { margin: 3px 0; }
            .sheet .sheet-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            .sheet .sheet-table th, .sheet .sheet-table td { border: 1px solid #ccc; padding: 8px 12px; text-align: left; }
            .sheet .sheet-table th { background-color: #f0f0f0; font-weight: bold; font-size: 0.9em; color: #333; }
            .sheet .sheet-table td { font-size: 0.9em; }
            .sheet .sheet-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 40mm; }
            .sheet .sheet-signature-area { text-align: center; flex: 1; margin-right: 20mm; }
            .sheet .sheet-signature-area p { margin: 5px 0; font-size: 0.9em; }
            .sheet .sheet-signature-area p:first-child { font-weight: bold; text-decoration: underline; margin-bottom: 15px; }
            .sheet .stamp-area { width: 100mm; height: 35mm; border: 2px dashed #999; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; color: #666; text-transform: uppercase; flex-shrink: 0; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <img id="header-logo-img" src="" alt="Logo de l'école" class="header-logo" style="display: none;">
            <div id="header-logo-placeholder" class="header-logo" style="display: flex; align-items: center; justify-content: center; background-color: white; color: var(--light-text-color); font-size: 0.8em; text-align: center; border: 1px dashed var(--border-color);">[ LOGO ]</div>
            <h1 data-lang-key="app-title">Gestion Scolaire Afrique</h1>
            <div class="school-info">
                <p><strong><span data-lang-key="school-name-label">Nom :</span></strong> <span id="header-school-name"></span></p>
                <p><strong><span data-lang-key="school-phone-label">Tél :</span></strong> <span id="header-school-phone"></span></p>
            </div>
        </div>
        <div class="header-right">
            <div class="year-selector">
                <label for="currentSchoolYearSelect" data-lang-key="current-school-year">Année Scolaire :</label>
                <select id="currentSchoolYearSelect"></select>
            </div>
            <div class="year-selector" style="margin-left: 20px;">
                <label for="schoolSelect">Établissement :</label>
                <select id="schoolSelect"></select>
            </div>
        </div>
    </header>

    <div class="main-content">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="#dashboard-section" class="nav-link active" data-section="dashboard-section"><i class="fas fa-home"></i> <span data-lang-key="dashboard">Tableau de bord</span></a></li>
                    <li><a href="#student-section" class="nav-link" data-section="student-section"><i class="fas fa-user-graduate"></i> <span data-lang-key="students">Élèves</span></a></li>
                    <li><a href="#payment-section" class="nav-link" data-section="payment-section"><i class="fas fa-money-bill-wave"></i> <span data-lang-key="payments">Paiements</span></a></li>
                    <li><a href="#grades-section" class="nav-link" data-section="grades-section"><i class="fas fa-chart-line"></i> <span data-lang-key="grades">Notes & Bulletins</span></a></li>
                    <li><a href="#teacher-section" class="nav-link" data-section="teacher-section"><i class="fas fa-chalkboard-teacher"></i> <span data-lang-key="teachers">Enseignants</span></a></li>
                    <li><a href="#stats-section" class="nav-link" data-section="stats-section"><i class="fas fa-chart-bar"></i> <span data-lang-key="statistics">Statistiques</span></a></li>
                    <li><a href="#settings-section" class="nav-link" data-section="settings-section"><i class="fas fa-cog"></i> <span data-lang-key="settings">Paramètres</span></a></li>
                    <li><a href="#inspection-section" class="nav-link" data-section="inspection-section"><i class="fas fa-user-tie"></i> <span data-lang-key="inspection">Inspection</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-bottom">
                <div class="theme-switch-container">
                    <label data-lang-key="dark-mode">Mode Sombre :</label>
                    <label class="theme-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="language-selector">
                    <label for="languageSelect">Langue :</label>
                    <select id="languageSelect">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                        <option value="wo">Wolof</option>
                        <option value="bm">Bambara</option>
                        <option value="ff">Fulfulde</option>
                    </select>
                </div>
                <div style="padding: 10px 20px; text-align: center;">
                    <button class="btn btn-small" onclick="exportBackup()"><i class="fas fa-save"></i> Sauvegarder</button>
                    <button class="btn btn-small btn-secondary" onclick="importBackup()"><i class="fas fa-upload"></i> Restaurer</button>
                </div>
            </div>
        </aside>

        <main class="content">
            <section id="dashboard-section" class="content-section" aria-labelledby="dashboard-title-heading">
                <h2 id="dashboard-title-heading"><i class="fas fa-home"></i> Tableau de Bord</h2>
                <p data-lang-key="welcome-message">Bienvenue dans votre application de gestion scolaire.</p>

                <h3><span data-lang-key="quick-stats">Statistiques Rapides</span> (<span id="dashboardSchoolYearDisplay"></span>)</h3>
                <div class="stats-grid">
                    <div class="stat-card students">
                        <h3 data-lang-key="total-students">Total Élèves</h3>
                        <p id="dashboard-total-students">0</p>
                    </div>
                    <div class="stat-card collected">
                        <h3 data-lang-key="total-collected">Total Collecté</h3>
                        <p id="dashboard-total-collected">0 FCFA</p>
                    </div>
                    <div class="stat-card remaining">
                        <h3 data-lang-key="remaining-balance">Reste à Payer</h3>
                        <p id="dashboard-remaining-balance">0 FCFA</p>
                    </div>
                </div>

                <h3 style="margin-top: 40px;"><span data-lang-key="recent-payments">Paiements Récents</span></h3>
                <table id="recent-payments-table">
                    <thead>
                        <tr>
                            <th data-lang-key="payment-date">Date</th>
                            <th data-lang-key="student-name">Élève</th>
                            <th data-lang-key="payment-amount">Montant Payé</th>
                            <th data-lang-key="payment-status">Statut</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="recent-payments-pagination">
                    <button id="prevRecentBtn" disabled data-lang-key="previous">Précédent</button>
                    <span><span id="currentPageRecent">1</span> / <span id="totalPagesRecent">1</span></span>
                    <button id="nextRecentBtn" data-lang-key="next">Suivant</button>
                </div>
            </section>

            <section id="student-section" class="content-section" style="display:none;" aria-labelledby="student-management-title-heading">
                <h2 id="student-management-title-heading"><i class="fas fa-user-graduate"></i> Gestion des Élèves</h2>
                <div id="student-message" class="message"></div>

                <h3>Ajouter un Nouvel Élève</h3>
                <form id="add-student-form">
                    <div class="form-grid">
                        <div class="form-group"><label for="studentMatricule">Matricule</label><input type="text" id="studentMatricule" required></div>
                        <div class="form-group"><label for="studentName">Nom complet</label><input type="text" id="studentName" required></div>
                        <div class="form-group"><label for="studentGender">Genre</label><div class="radio-group"><div><input type="radio" id="genderM" name="studentGender" value="M" required><label for="genderM">M</label></div><div><input type="radio" id="genderF" name="studentGender" value="F" required><label for="genderF">F</label></div></div></div>
                        <div class="form-group"><label for="studentClass">Classe</label><input type="text" id="studentClass" required></div>
                        <div class="form-group"><label for="studentStatus">Statut</label><select id="studentStatus"><option value="Affecté">Affecté</option><option value="En attente">En attente</option><option value="Retiré">Retiré</option></select></div>
                        <div class="form-group"><label for="totalAmount">Montant total à payer (FCFA)</label><input type="number" id="totalAmount" min="0" value="0" required></div>
                        <div class="form-group"><label for="scholarshipType">Type de bourse</label><select id="scholarshipType"><option value="Aucune">Aucune</option><option value="Partielle">Partielle</option><option value="Totale">Totale</option></select></div>
                        <div class="form-group"><label for="scholarshipAmount">Montant de la bourse (FCFA)</label><input type="number" id="scholarshipAmount" min="0" value="0"></div>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Ajouter Élève</button>
                </form>

                <h3 style="margin-top: 40px;">Liste des Élèves (<span id="studentListSchoolYearDisplay"></span>)</h3>
                <div style="margin-bottom: 20px;"><label for="studentListClassFilter">Filtrer par Classe :</label><select id="studentListClassFilter"><option value="">Toutes les classes</option></select></div>
                <table id="student-table">
                    <thead><tr><th>Matricule</th><th>Nom complet</th><th>Genre</th><th>Classe</th><th>Statut</th><th>Total Dû</th><th>Total Payé</th><th>Solde</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="student-pagination"><button id="prevStudentBtn" disabled>Précédent</button><span><span id="currentPageStudent">1</span> / <span id="totalPagesStudent">1</span></span><button id="nextStudentBtn">Suivant</button></div>
            </section>

            <section id="payment-section" class="content-section" style="display:none;" aria-labelledby="payment-history-title-heading">
                <h2 id="payment-history-title-heading"><i class="fas fa-money-bill-wave"></i> Historique des Paiements (<span id="currentSchoolYearPaymentDisplay"></span>)</h2>
                <div id="payment-message" class="message"></div>
                <div style="margin-bottom: 20px;"><label for="classFilter">Filtrer par Classe :</label><select id="classFilter"><option value="">Toutes les classes</option></select></div>
                <table id="payment-table">
                    <thead><tr><th>Date</th><th>Matricule</th><th>Élève</th><th>Classe</th><th>Montant Payé</th><th>Type de Paiement</th><th>Catégorie de Frais</th><th>Référence</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div class="pagination" id="payment-pagination"><button id="prevPaymentBtn" disabled>Précédent</button><span><span id="currentPagePayment">1</span> / <span id="totalPagesPayment">1</span></span><button id="nextPaymentBtn">Suivant</button></div>
            </section>

            <section id="grades-section" class="content-section" style="display:none;" aria-labelledby="grades-title-heading">
                <h2 id="grades-title-heading"><i class="fas fa-chart-line"></i> Notes & Bulletins</h2>
                <div id="grades-message" class="message"></div>

                <h3>Saisie des Notes</h3>
                <form id="add-grade-form">
                    <div class="form-grid">
                        <div class="form-group"><label for="gradeStudentSelect">Élève</label><select id="gradeStudentSelect" required></select></div>
                        <div class="form-group"><label for="gradeSubject">Matière</label><input type="text" id="gradeSubject" required></div>
                        <div class="form-group"><label for="gradeType">Type</label><select id="gradeType"><option value="Devoir">Devoir</option><option value="Composition">Composition</option><option value="Exam">Exam</option></select></div>
                        <div class="form-group"><label for="gradeValue">Note (/20)</label><input type="number" id="gradeValue" min="0" max="20" step="0.1" required></div>
                        <div class="form-group"><label for="gradeCoefficient">Coefficient</label><input type="number" id="gradeCoefficient" min="1" value="1" required></div>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Ajouter Note</button>
                </form>

                <h3 style="margin-top: 40px;">Bulletin de Notes</h3>
                <div class="form-grid">
                    <div class="form-group"><label for="bulletinStudentSelect">Élève</label><select id="bulletinStudentSelect"></select></div>
                    <div class="form-group"><label for="bulletinTerm">Trimestre</label><select id="bulletinTerm"><option value="T1">1er Trimestre</option><option value="T2">2e Trimestre</option><option value="T3">3e Trimestre</option></select></div>
                </div>
                <button class="btn" onclick="generateBulletin()"><i class="fas fa-file-pdf"></i> Générer Bulletin PDF</button>
                <button class="btn btn-secondary" onclick="sendBulletinByWhatsApp()"><i class="fab fa-whatsapp"></i> Envoyer par WhatsApp</button>

                <h3 style="margin-top: 40px;">Historique des Notes</h3>
                <table id="grades-table">
                    <thead><tr><th>Élève</th><th>Matière</th><th>Type</th><th>Note</th><th>Coefficient</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>

            <section id="teacher-section" class="content-section" style="display:none;" aria-labelledby="teacher-management-title-heading">
                <h2 id="teacher-management-title-heading"><i class="fas fa-chalkboard-teacher"></i> Gestion des Enseignants</h2>
                <div id="teacher-message" class="message"></div>

                <h3>Ajouter un Enseignant</h3>
                <form id="add-teacher-form">
                    <div class="form-grid">
                        <div class="form-group"><label for="teacherName">Nom complet</label><input type="text" id="teacherName" required></div>
                        <div class="form-group"><label for="teacherSubject">Matière</label><input type="text" id="teacherSubject" required></div>
                        <div class="form-group"><label for="teacherClass">Classe principale</label><input type="text" id="teacherClass" required></div>
                        <div class="form-group"><label for="teacherPhone">Téléphone</label><input type="text" id="teacherPhone"></div>
                        <div class="form-group"><label for="teacherSalary">Salaire mensuel (FCFA)</label><input type="number" id="teacherSalary" min="0" value="0"></div>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Ajouter Enseignant</button>
                </form>

                <h3 style="margin-top: 40px;">Liste des Enseignants</h3>
                <table id="teacher-table">
                    <thead><tr><th>Nom</th><th>Matière</th><th>Classe</th><th>Téléphone</th><th>Salaire</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>

            <section id="stats-section" class="content-section" style="display:none;" aria-labelledby="stats-overview-title-heading">
                <h2 id="stats-overview-title-heading"><i class="fas fa-chart-bar"></i> Statistiques Annuelles (<span id="statsYearDisplay"></span>)</h2>
                <div style="text-align: center; margin-bottom: 20px;"><label for="statsSchoolYearSelect">Sélectionner l'année scolaire :</label><select id="statsSchoolYearSelect"></select></div>
                <div style="margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 20px;"><label for="statsClassFilter">Filtrer par Classe :</label><select id="statsClassFilter"><option value="">Toutes les classes</option></select></div>
                
                <div style="text-align: center; margin-top: 30px; margin-bottom: 30px; display: flex; justify-content: center; gap: 15px;">
                    <button class="btn" id="generateStudentSheetBtn" onclick="generateStudentSheet()"><i class="fas fa-file-invoice"></i> Générer Fiche d'Inscription</button>
                    <button class="btn btn-secondary" id="generateTuitionFeesSheetBtn" onclick="generateTuitionFeesSheet()"><i class="fas fa-dollar-sign"></i> Générer Fiche Frais Scolarité</button>
                    <button class="btn btn-info" id="generateClassSheetBtn" onclick="generateClassSheet()"><i class="fas fa-users"></i> Générer Fiche de Classe</button>
                    <button class="btn" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card students"><h3>Total Élèves Inscrits</h3><p id="stats-total-students">0</p></div>
                    <div class="stat-card collected"><h3>Total Collecté cette année</h3><p id="stats-total-collected">0 FCFA</p></div>
                    <div class="stat-card remaining"><h3>Reste à Payer cette année</h3><p id="stats-remaining-balance">0 FCFA</p></div>
                </div>

                <h3 style="text-align: center; margin-top: 40px; margin-bottom: 20px; color: var(--text-color);">Répartition par Niveau</h3>
                <table id="level-stats-table">
                    <thead><tr><th>Niveau</th><th>Nb Élèves</th><th>Total Dû</th><th>Total Payé</th><th>Reste à Payer</th></tr></thead>
                    <tbody id="level-stats-body"></tbody>
                </table>
            </section>

            <section id="settings-section" class="content-section" style="display:none;" aria-labelledby="school-settings-title-heading">
                <h2 id="school-settings-title-heading"><i class="fas fa-cog"></i> Paramètres de l'école</h2>
                <div id="settings-message" class="message"></div>
                <div class="form-group"><label for="schoolName">Nom de l'école</label><input type="text" id="schoolName"></div>
                <div class="form-group"><label for="schoolPhone">Téléphone</label><input type="text" id="schoolPhone"></div>
                <div class="form-group"><label for="schoolAddress">Adresse</label><textarea id="schoolAddress"></textarea></div>
                <div class="form-group">
                    <label for="schoolLogo">Logo de l'école (format image)</label>
                    <input type="file" id="schoolLogo" accept="image/*">
                    <div class="logo-upload-preview"><img id="logoPreview" src="" alt="Aperçu du logo" style="display:none;"><div id="logoPlaceholder" class="placeholder">Aperçu du logo</div></div>
                </div>
                <div class="form-group"><label for="signatureName">Nom du signataire (pour reçus)</label><input type="text" id="signatureName"></div>
                <div class="form-group"><label for="signatureTitle">Titre du signataire (pour reçus)</label><input type="text" id="signatureTitle"></div>
                <div class="form-group"><label for="schoolYearStartMonth">Mois de début de l'année scolaire</label><select id="schoolYearStartMonth"><option value="1">Janvier</option><option value="2">Février</option><option value="3">Mars</option><option value="4">Avril</option><option value="5">Mai</option><option value="6">Juin</option><option value="7">Juillet</option><option value="8">Août</option><option value="9">Septembre</option><option value="10">Octobre</option><option value="11">Novembre</option><option value="12">Décembre</option></select></div>
                <div class="form-group"><label>Importer des élèves (CSV)</label><div id="dropZoneImportStudents" class="drop-zone"><span>Glissez-déposez le fichier CSV ici ou cliquez pour le sélectionner</span><input type="file" id="importStudentsCsv" accept=".csv" /></div><p id="import-students-status" class="message info" style="display: none;"></p></div>
                <button id="saveSettingsBtn" class="btn"><i class="fas fa-save"></i> Enregistrer les Paramètres</button>
            </section>

            <section id="inspection-section" class="content-section" style="display:none;" aria-labelledby="inspection-title-heading">
                <h2 id="inspection-title-heading"><i class="fas fa-user-tie"></i> Mode Inspection</h2>
                <p style="text-align: center; color: var(--info-color);">Mode lecture seule pour les inspections</p>
                <div class="stats-grid">
                    <div class="stat-card students"><h3>Total Élèves</h3><p id="inspection-total-students">0</p></div>
                    <div class="stat-card collected"><h3>Total Collecté</h3><p id="inspection-total-collected">0 FCFA</p></div>
                    <div class="stat-card remaining"><h3>Reste à Payer</h3><p id="inspection-remaining-balance">0 FCFA</p></div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="exportInspectionExcel()"><i class="fas fa-file-excel"></i> Export Excel Inspection</button>
                </div>
            </section>
        </main>
    </div>

    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn">&times;</span>
            <h2>Enregistrer un Paiement</h2>
            <div id="modal-message" class="message"></div>
            <form id="payment-form">
                <div class="form-group"><label for="modalStudentName">Élève</label><input type="text" id="modalStudentName" readonly><input type="hidden" id="modalStudentId"></div>
                <div class="form-group"><label>Solde restant</label><p id="modalRemainingBalance" style="font-weight: bold; color: var(--error-color);">0 FCFA</p></div>
                <div class="form-group"><label for="paymentAmount">Montant du paiement (FCFA)</label><input type="number" id="paymentAmount" min="1" required></div>
                <div class="form-group"><label>Mode de paiement</label><div class="checkbox-group"><div><input type="checkbox" id="paymentTypeOrange" name="paymentType" value="Orange Money"><label for="paymentTypeOrange">Orange Money</label></div><div><input type="checkbox" id="paymentTypeMoov" name="paymentType" value="Moov Money"><label for="paymentTypeMoov">Moov Money</label></div><div><input type="checkbox" id="paymentTypeMTN" name="paymentType" value="MTN Money"><label for="paymentTypeMTN">MTN Money</label></div><div><input type="checkbox" id="paymentTypeWave" name="paymentType" value="Wave"><label for="paymentTypeWave">Wave</label></div><div><input type="checkbox" id="paymentTypePush" name="paymentType" value="Push"><label for="paymentTypePush">Push</label></div><div><input type="checkbox" id="paymentTypeCash" name="paymentType" value="Cash"><label for="paymentTypeCash">Cash</label></div></div></div>
                <div class="form-group"><label>Catégorie de frais</label><div class="checkbox-group"><div><input type="checkbox" id="feeCategoryScolarite" name="feeCategory" value="Frais de Scolarité"><label for="feeCategoryScolarite">Frais de Scolarité</label></div><div><input type="checkbox" id="feeCategoryInscription" name="feeCategory" value="Frais d'inscription"><label for="feeCategoryInscription">Frais d'inscription</label></div><div><input type="checkbox" id="feeCategoryUniforme" name="feeCategory" value="Uniforme"><label for="feeCategoryUniforme">Uniforme</label></div><div><input type="checkbox" id="feeCategoryCantine" name="feeCategory" value="Cantine"><label for="feeCategoryCantine">Cantine</label></div><div><input type="checkbox" id="feeCategoryTransport" name="feeCategory" value="Transport"><label for="feeCategoryTransport">Transport</label></div><div><input type="checkbox" id="feeCategoryExam" name="feeCategory" value="Examens"><label for="feeCategoryExam">Examens</label></div><div><input type="checkbox" id="feeCategoryOther" name="feeCategory" value="Autre"><label for="feeCategoryOther">Autre</label></div></div></div>
                <div class="form-group"><label for="paymentRef">Référence du paiement (Optionnel)</label><input type="text" id="paymentRef"></div>
                <div class="form-group"><label for="paymentDate">Date du prochain versement</label><input type="date" id="paymentDate"></div>
                <div class="modal-footer">
                    <button type="submit" class="btn" id="recordPaymentBtn"><i class="fas fa-receipt"></i> Enregistrer Paiement</button>
                    <button type="button" class="btn btn-secondary" id="printReceiptBtn" style="display: none;"><i class="fas fa-print"></i> Imprimer Reçu</button>
                    <button type="button" class="btn btn-small" onclick="sendPaymentSMS()"><i class="fas fa-sms"></i> SMS</button>
                    <button type="button" class="btn btn-small btn-secondary" onclick="sendPaymentWhatsApp()"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="print-container" style="display: none;"></div>

    <script>
        // === GLOBAL DATA ===
        let appData = {
            schools: {},
            currentSchool: 'École Primaire',
            currentSchoolYear: '',
            settings: {
                schoolName: 'École Primaire',
                schoolPhone: '+221 77 123 45 67',
                schoolAddress: 'Dakar, Sénégal',
                schoolLogo: '',
                signatureName: 'Le Directeur',
                signatureTitle: 'Directeur',
                schoolYearStartMonth: 9
            }
        };
        let currentLanguage = 'fr';
        let isDarkMode = false;
        const STUDENTS_PER_PAGE = 10;
        const PAYMENTS_PER_PAGE = 10;
        const RECENT_PAYMENTS_COUNT = 5;

        const translations = {
            fr: {
                "app-title": "Gestion Scolaire Afrique",
                "dashboard": "Tableau de bord",
                "students": "Élèves",
                "payments": "Paiements",
                "grades": "Notes & Bulletins",
                "teachers": "Enseignants",
                "statistics": "Statistiques",
                "settings": "Paramètres",
                "inspection": "Inspection",
                "current-school-year": "Année Scolaire :",
                "school-name-label": "Nom :",
                "school-phone-label": "Tél :",
                "dashboard-title": "Tableau de Bord",
                "welcome-message": "Bienvenue dans votre application de gestion scolaire.",
                "quick-stats": "Statistiques Rapides",
                "total-students": "Total Élèves",
                "total-collected": "Total Collecté",
                "remaining-balance": "Reste à Payer",
                "recent-payments": "Paiements Récents",
                "payment-date": "Date",
                "student-name": "Élève",
                "payment-amount": "Montant Payé",
                "payment-status": "Statut",
                "previous": "Précédent",
                "next": "Suivant",
                "student-management-title": "Gestion des Élèves",
                "add-new-student": "Ajouter un Nouvel Élève",
                "student-matricule": "Matricule",
                "student-full-name": "Nom complet",
                "student-gender": "Genre",
                "gender-male": "M",
                "gender-female": "F",
                "student-class": "Classe",
                "student-status": "Statut",
                "status-affected": "Affecté",
                "status-pending": "En attente",
                "status-withdrawn": "Retiré",
                "total-amount-due": "Montant total à payer (FCFA)",
                "add-student": "Ajouter Élève",
                "student-list": "Liste des Élèves",
                "total-amount-paid": "Total Payé",
                "balance": "Solde",
                "actions": "Actions",
                "edit": "Modifier",
                "record-payment-action": "Enregistrer Paiement",
                "delete": "Supprimer",
                "payment-history-title": "Historique des Paiements",
                "payment-reference": "Référence",
                "payment-type": "Mode de paiement",
                "fee-category": "Catégorie de frais",
                "payment-type-cash": "Espèces",
                "fee-scolarite": "Frais de Scolarité",
                "fee-inscription": "Frais d'inscription",
                "fee-other": "Autre",
                "stats-overview-title": "Statistiques Annuelles",
                "select-stats-year": "Sélectionner l'année scolaire :",
                "total-students-enrolled": "Total Élèves Inscrits",
                "total-collected-this-year": "Total Collecté cette année",
                "remaining-balance-this-year": "Reste à Payer cette année",
                "school-settings-title": "Paramètres de l'école",
                "school-phone": "Téléphone",
                "school-address": "Adresse",
                "school-logo": "Logo de l'école (format image)",
                "logo-preview-placeholder": "Aperçu du logo",
                "signature-name": "Nom du signataire (pour reçus)",
                "signature-title": "Titre du signataire (pour reçus)",
                "school-year-start-month": "Mois de début de l'année scolaire",
                "january": "Janvier",
                "february": "Février",
                "march": "Mars",
                "april": "Avril",
                "may": "Mai",
                "june": "Juin",
                "july": "Juillet",
                "august": "Août",
                "september": "Septembre",
                "october": "Octobre",
                "november": "Novembre",
                "december": "Décembre",
                "save-settings": "Enregistrer les Paramètres",
                "record-payment-title": "Enregistrer un Paiement",
                "record-payment": "Enregistrer Paiement",
                "print-receipt": "Imprimer Reçu",
                "confirm-delete-student": "Voulez-vous vraiment supprimer cet élève ? Tous les paiements associés seront également supprimés.",
                "confirm-delete-payment": "Voulez-vous vraiment supprimer ce paiement ?",
                "student-added-success": "Élève ajouté avec succès !",
                "student-updated-success": "Élève mis à jour avec succès !",
                "student-deleted-success": "Élève supprimé avec succès !",
                "payment-recorded-success": "Paiement enregistré avec succès !",
                "payment-deleted-success": "Paiement supprimé avec succès !",
                "settings-saved-success": "Paramètres enregistrés avec succès !",
                "error-fill-all-fields": "Veuillez remplir tous les champs obligatoires.",
                "error-matricule-exists": "Un élève avec ce matricule existe déjà pour cette année scolaire.",
                "error-invalid-amount": "Le montant du paiement doit être supérieur à 0 et ne doit pas dépasser le solde restant.",
                "error-loading-data": "Erreur lors du chargement des données.",
                "filter-by-class": "Filtrer par Classe :",
                "all-classes": "Toutes les classes",
                "import-students": "Importer des élèves (CSV)",
                "drag-drop-csv": "Glissez-déposez le fichier CSV ici ou cliquez pour le sélectionner",
                "csv-import-success": "Importation CSV terminée. {count} élèves ajoutés/mis à jour.",
                "csv-import-error": "Erreur lors de l'importation CSV : {error}",
                "generate-student-sheet-text": "Générer Fiche d'Inscription",
                "student-sheet-title": "FICHE D'INSCRIPTION",
                "number-of-students-label": "Nombre d'élèves :",
                "signature-student": "Signature Élève/Parent",
                "generate-tuition-fees-sheet-text": "Générer Fiche Frais Scolarité",
                "tuition-fees-sheet-title": "FICHE DE FRAIS DE SCOLARITÉ",
                "total-due-label": "Montant Total Dû",
                "total-paid-label": "Montant Total Payé",
                "remaining-balance-label": "Solde Restant",
                "generate-class-sheet-text": "Générer Fiche de Classe",
                "class-sheet-title": "FICHE DE CLASSE",
                "level-breakdown": "Répartition par Niveau",
                "level": "Niveau",
                "error-select-payment-type": "Veuillez sélectionner au moins un mode de paiement.",
                "error-select-fee-category": "Veuillez sélectionner au moins une catégorie de frais.",
                "create-new-year": "Créer une nouvelle année...",
                "prompt-new-year": "Entrez l'année de début de la nouvelle année scolaire (ex: 2025):",
                "year-exists": "Cette année scolaire existe déjà.",
                "no-students-found": "Aucun élève trouvé.",
                "no-payments-found": "Aucun paiement trouvé.",
                "no-recent-payments": "Aucun paiement récent.",
                "status-paid": "Payé",
                "status-partial": "Partiel",
                "status-unpaid": "Impayé",
                "select-language": "Langue :",
                "dark-mode": "Mode Sombre",
                "grades": "Notes & Bulletins",
                "teachers": "Enseignants",
                "inspection": "Inspection",
                "add-grade": "Ajouter Note",
                "grade-subject": "Matière",
                "grade-type": "Type",
                "grade-value": "Note",
                "grade-coefficient": "Coefficient",
                "bulletin": "Bulletin",
                "generate-bulletin": "Générer Bulletin",
                "send-whatsapp": "Envoyer WhatsApp",
                "teacher-name": "Nom complet",
                "teacher-subject": "Matière",
                "teacher-class": "Classe",
                "teacher-phone": "Téléphone",
                "teacher-salary": "Salaire",
                "add-teacher": "Ajouter Enseignant",
                "teacher-list": "Liste des Enseignants",
                "scholarship-type": "Type de bourse",
                "scholarship-amount": "Montant de la bourse",
                "export-pdf": "Export PDF",
                "export-excel": "Export Excel",
                "save-backup": "Sauvegarder",
                "restore-backup": "Restaurer",
                "backup-success": "Sauvegarde effectuée !",
                "restore-success": "Restauration effectuée !"
            }
        };

        // === STATE VARIABLES FOR PAGINATION ===
        let studentCurrentPage = 1;
        let paymentCurrentPage = 1;

        // === DATA FUNCTIONS ===
        function getSchoolData() {
            if (!appData.schools[appData.currentSchool]) {
                appData.schools[appData.currentSchool] = { schoolYears: {}, settings: { ...appData.settings } };
            }
            return appData.schools[appData.currentSchool];
        }

        function getSchoolYearData(year = appData.currentSchoolYear) {
            const school = getSchoolData();
            if (!school.schoolYears[year]) {
                school.schoolYears[year] = { students: [], payments: [], teachers: [], grades: [] };
            }
            return school.schoolYears[year];
        }

        function saveData() {
            localStorage.setItem('schoolAppDataAfrique', JSON.stringify(appData));
            localStorage.setItem('appLanguageAfrique', currentLanguage);
            localStorage.setItem('darkModeAfrique', isDarkMode);
        }

        function loadData() {
            const stored = localStorage.getItem('schoolAppDataAfrique');
            if (stored) {
                appData = JSON.parse(stored);
            }

            // Ensure currentSchool is valid
            if (!appData.schools[appData.currentSchool]) {
                const firstSchoolName = Object.keys(appData.schools)[0];
                appData.currentSchool = firstSchoolName || 'École Primaire';
            }

            // Ensure at least one school exists
            if (Object.keys(appData.schools).length === 0) {
                appData.schools['École Primaire'] = {
                    schoolYears: {},
                    settings: { ...appData.settings }
                };
            }

            // Load settings into the UI elements for the current school
            const school = getSchoolData();
            const settings = school.settings;
            document.getElementById('schoolName').value = settings.schoolName || '';
            document.getElementById('schoolPhone').value = settings.schoolPhone || '';
            document.getElementById('schoolAddress').value = settings.schoolAddress || '';
            document.getElementById('signatureName').value = settings.signatureName || '';
            document.getElementById('signatureTitle').value = settings.signatureTitle || '';
            document.getElementById('schoolYearStartMonth').value = settings.schoolYearStartMonth || 9;

            const logoImg = document.getElementById('logoPreview');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            if (settings.schoolLogo) {
                logoImg.src = settings.schoolLogo;
                logoImg.style.display = 'block';
                logoPlaceholder.style.display = 'none';
            } else {
                logoImg.style.display = 'none';
                logoPlaceholder.style.display = 'flex';
            }
            
            currentLanguage = localStorage.getItem('appLanguageAfrique') || 'fr';
            isDarkMode = localStorage.getItem('darkModeAfrique') === 'true';
            initializeCurrentYear();
        }

        function initializeCurrentYear() {
            const school = getSchoolData();
            const startMonth = school.settings.schoolYearStartMonth || 9;
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            let yearStart = currentMonth >= startMonth ? currentYear : currentYear - 1;
            const determinedYear = `${yearStart}-${yearStart + 1}`;
            
            if (!appData.currentSchoolYear || !school.schoolYears[appData.currentSchoolYear]) {
                appData.currentSchoolYear = determinedYear;
            }
            
            getSchoolYearData(appData.currentSchoolYear); // Ensure the current year data structure exists
            saveData();
        }

        // === UI FUNCTIONS ===
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguageAfrique', currentLanguage);
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.dataset.langKey;
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            updateAllDisplays();
        }

        function toggleDarkMode(enabled) {
            isDarkMode = enabled;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('darkModeToggle').checked = isDarkMode;
            saveData();
        }

        function updateAllDisplays() {
            updateHeaderInfo();
            populateSchoolSelectors();
            populateSchoolYearSelectors();
            updateSchoolYearDisplays();
            updateDashboardStats();
            updateStatsSection();
            populateClassFilters();
            renderStudentTable(studentCurrentPage);
            renderPaymentHistory(paymentCurrentPage);
            renderGradesTable();
            renderTeacherTable();
            renderRecentPayments();
            populateStudentSelectors();
        }

        function updateHeaderInfo() {
            const school = getSchoolData();
            const settings = school.settings;
            if (!settings) return;
            document.getElementById('header-school-name').textContent = settings.schoolName;
            document.getElementById('header-school-phone').textContent = settings.schoolPhone;
            const logoImg = document.getElementById('header-logo-img');
            const logoPlaceholder = document.getElementById('header-logo-placeholder');
            if (settings.schoolLogo) {
                logoImg.src = settings.schoolLogo;
                logoImg.style.display = 'block';
                logoPlaceholder.style.display = 'none';
            } else {
                logoImg.style.display = 'none';
                logoPlaceholder.style.display = 'flex';
            }
        }
        
        function populateSchoolSelectors() {
            const schoolSelect = document.getElementById('schoolSelect');
            schoolSelect.innerHTML = '';
            Object.keys(appData.schools).forEach(name => schoolSelect.add(new Option(name, name)));
            schoolSelect.value = appData.currentSchool;
        }

        function populateSchoolYearSelectors() {
            const school = getSchoolData();
            const years = Object.keys(school.schoolYears).sort().reverse();
            [document.getElementById('currentSchoolYearSelect'), document.getElementById('statsSchoolYearSelect')].forEach(select => {
                const selected = select.value;
                select.innerHTML = '';
                years.forEach(year => select.add(new Option(year, year)));
                select.add(new Option(translations[currentLanguage]['create-new-year'], 'new'));
                select.value = selected && years.includes(selected) ? selected : appData.currentSchoolYear;
            });
            document.getElementById('statsSchoolYearSelect').value = appData.currentSchoolYear;
        }

        function updateSchoolYearDisplays() {
            const year = appData.currentSchoolYear;
            document.getElementById('dashboardSchoolYearDisplay').textContent = year;
            document.getElementById('currentSchoolYearPaymentDisplay').textContent = year;
            document.getElementById('studentListSchoolYearDisplay').textContent = year;
            document.getElementById('statsYearDisplay').textContent = document.getElementById('statsSchoolYearSelect').value;
        }

        function showMessage(element, msg, type) {
            element.textContent = msg;
            element.className = `message ${type}`;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 5000);
        }

        function formatCurrency(amount) {
            return `${(amount || 0).toLocaleString('fr-FR')} FCFA`;
        }
        
        function getPaymentStatus(student) {
            const balance = student.totalAmount - student.amountPaid;
            if (balance <= 0) return translations[currentLanguage]['status-paid'];
            if (student.amountPaid > 0) return translations[currentLanguage]['status-partial'];
            return translations[currentLanguage]['status-unpaid'];
        }

        function populateClassFilters() {
            const yearData = getSchoolYearData();
            const students = yearData.students;
            const classes = [...new Set(students.map(s => s.className))].sort();
            ['classFilter', 'studentListClassFilter', 'statsClassFilter'].forEach(id => {
                const select = document.getElementById(id);
                const current = select.value;
                select.innerHTML = `<option value="">${translations[currentLanguage]['all-classes']}</option>`;
                classes.forEach(cls => select.add(new Option(cls, cls)));
                if (classes.includes(current)) select.value = current;
            });
        }
        
        function populateStudentSelectors() {
            const yearData = getSchoolYearData();
            const students = yearData.students;
            const gradeSelect = document.getElementById('gradeStudentSelect');
            const bulletinSelect = document.getElementById('bulletinStudentSelect');
            
            [gradeSelect, bulletinSelect].forEach(select => {
                const current = select.value;
                select.innerHTML = '';
                students.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => select.add(new Option(s.name, s.id)));
                if (current) select.value = current;
            });
        }

        // === DASHBOARD & STATS FUNCTIONS ===
        function getSummaryStats(year = appData.currentSchoolYear, classFilter = '') {
            const yearData = getSchoolYearData(year);
            let students = yearData.students;
            
            if (classFilter) {
                students = students.filter(s => s.className === classFilter);
            }

            const totalStudents = students.length;
            const totalCollected = students.reduce((sum, s) => sum + s.amountPaid, 0);
            const totalDue = students.reduce((sum, s) => sum + s.totalAmount, 0);
            const remainingBalance = totalDue - totalCollected;

            return { totalStudents, totalCollected, remainingBalance, totalDue };
        }

        function updateDashboardStats() {
            const { totalStudents, totalCollected, remainingBalance } = getSummaryStats(appData.currentSchoolYear);
            document.getElementById('dashboard-total-students').textContent = totalStudents;
            document.getElementById('dashboard-total-collected').textContent = formatCurrency(totalCollected);
            document.getElementById('dashboard-remaining-balance').textContent = formatCurrency(remainingBalance);
        }

        function updateStatsSection() {
            const selectedYear = document.getElementById('statsSchoolYearSelect').value;
            const classFilter = document.getElementById('statsClassFilter').value;
            const { totalStudents, totalCollected, remainingBalance, totalDue } = getSummaryStats(selectedYear, classFilter);

            document.getElementById('statsYearDisplay').textContent = selectedYear;
            document.getElementById('stats-total-students').textContent = totalStudents;
            document.getElementById('stats-total-collected').textContent = formatCurrency(totalCollected);
            document.getElementById('stats-remaining-balance').textContent = formatCurrency(remainingBalance);
            
            // Level breakdown
            const yearData = getSchoolYearData(selectedYear);
            let students = yearData.students;
            if (classFilter) students = students.filter(s => s.className === classFilter);

            const levelStats = students.reduce((acc, student) => {
                const level = student.className;
                if (!acc[level]) acc[level] = { count: 0, collected: 0, due: 0 };
                acc[level].count++;
                acc[level].collected += student.amountPaid;
                acc[level].due += student.totalAmount;
                return acc;
            }, {});

            const tbody = document.getElementById('level-stats-body');
            tbody.innerHTML = '';
            Object.keys(levelStats).sort().forEach(level => {
                const stats = levelStats[level];
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${level}</td>
                    <td>${stats.count}</td>
                    <td>${formatCurrency(stats.due)}</td>
                    <td>${formatCurrency(stats.collected)}</td>
                    <td>${formatCurrency(stats.due - stats.collected)}</td>
                `;
            });
            if (Object.keys(levelStats).length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Aucune donnée de niveau trouvée.</td></tr>`;
            }
        }

        function renderRecentPayments() {
            const yearData = getSchoolYearData();
            const payments = [...(yearData.payments || [])].sort((a,b) => new Date(b.date) - new Date(a.date));
            const recent = payments.slice(0, RECENT_PAYMENTS_COUNT);
            const tbody = document.querySelector('#recent-payments-table tbody');
            tbody.innerHTML = '';

            if (recent.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${translations[currentLanguage]['no-recent-payments']}</td></tr>`;
                document.getElementById('recent-payments-pagination').style.display = 'none';
                return;
            }
            document.getElementById('recent-payments-pagination').style.display = 'flex';

            recent.forEach(payment => {
                const student = yearData.students.find(s => s.id === payment.studentId);
                const status = student ? getPaymentStatus(student) : 'N/A';
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(payment.date).toLocaleDateString('fr-FR')}</td>
                    <td>${payment.name} (${payment.matricule})</td>
                    <td>${formatCurrency(payment.amount)}</td>
                    <td>${status}</td>
                `;
            });
            
            // Simple display of pagination info, no real pagination implemented here for simplicity
            document.getElementById('currentPageRecent').textContent = 1;
            document.getElementById('totalPagesRecent').textContent = 1;
            document.getElementById('prevRecentBtn').disabled = true;
            document.getElementById('nextRecentBtn').disabled = true;
        }


        // === STUDENT FUNCTIONS ===
        function addOrUpdateStudent(studentData, id = null) {
            const yearData = getSchoolYearData();
            const existing = yearData.students.find(s => s.matricule.toLowerCase() === studentData.matricule.toLowerCase() && s.id !== id);
            if (existing) {
                showMessage(document.getElementById('student-message'), translations[currentLanguage]['error-matricule-exists'], 'error');
                return false;
            }
            if (id) {
                const index = yearData.students.findIndex(s => s.id === id);
                if (index > -1) {
                    yearData.students[index] = { ...yearData.students[index], ...studentData };
                    showMessage(document.getElementById('student-message'), translations[currentLanguage]['student-updated-success'], 'success');
                }
            } else {
                yearData.students.push({ id: Date.now(), amountPaid: 0, ...studentData });
                showMessage(document.getElementById('student-message'), translations[currentLanguage]['student-added-success'], 'success');
            }
            saveData();
            populateClassFilters();
            updateAllDisplays();
            return true;
        }

        function deleteStudent(id) {
            if (!confirm(translations[currentLanguage]['confirm-delete-student'])) return;
            const yearData = getSchoolYearData();
            yearData.students = yearData.students.filter(s => s.id !== id);
            yearData.payments = yearData.payments.filter(p => p.studentId !== id);
            saveData();
            showMessage(document.getElementById('student-message'), translations[currentLanguage]['student-deleted-success'], 'success');
            renderStudentTable(studentCurrentPage);
            updateAllDisplays();
        }

        function renderStudentTable(page = 1) {
            const yearData = getSchoolYearData();
            const selectedClass = document.getElementById('studentListClassFilter').value;
            let filtered = selectedClass ? yearData.students.filter(s => s.className === selectedClass) : [...yearData.students];
            
            // Sorting and Pagination logic
            filtered.sort((a,b) => a.name.localeCompare(b.name));
            const totalPages = Math.ceil(filtered.length / STUDENTS_PER_PAGE);
            studentCurrentPage = Math.min(Math.max(1, page), totalPages || 1);
            const start = (studentCurrentPage - 1) * STUDENTS_PER_PAGE;
            const paginated = filtered.slice(start, start + STUDENTS_PER_PAGE);

            const tbody = document.querySelector('#student-table tbody');
            tbody.innerHTML = '';
            
            if (paginated.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center;">${translations[currentLanguage]['no-students-found']}</td></tr>`;
            } else {
                paginated.forEach(student => {
                    const balance = student.totalAmount - student.amountPaid;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${student.matricule}</td>
                        <td>${student.name}</td>
                        <td>${student.gender || 'N/A'}</td>
                        <td>${student.className}</td>
                        <td>${student.status}</td>
                        <td>${formatCurrency(student.totalAmount)}</td>
                        <td>${formatCurrency(student.amountPaid)}</td>
                        <td>${formatCurrency(balance)}</td>
                        <td>
                            <button class="btn btn-small" onclick="openEditStudentForm(${student.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-small btn-secondary" onclick="openPaymentModal(${student.id})"><i class="fas fa-money-bill-wave"></i></button>
                            <button class="btn btn-small btn-danger" onclick="deleteStudent(${student.id})"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            }

            // Update pagination UI
            document.getElementById('currentPageStudent').textContent = studentCurrentPage;
            document.getElementById('totalPagesStudent').textContent = totalPages;
            document.getElementById('prevStudentBtn').disabled = studentCurrentPage === 1;
            document.getElementById('nextStudentBtn').disabled = studentCurrentPage === totalPages || totalPages === 0;
            
            // Add listeners for pagination buttons
            document.getElementById('prevStudentBtn').onclick = () => renderStudentTable(studentCurrentPage - 1);
            document.getElementById('nextStudentBtn').onclick = () => renderStudentTable(studentCurrentPage + 1);
            
            // Add listener for class filter change
            document.getElementById('studentListClassFilter').onchange = () => renderStudentTable(1);
        }

        function getStudentById(id) {
            const yearData = getSchoolYearData();
            return yearData.students.find(s => s.id === id);
        }

        function openEditStudentForm(id) {
            const student = getStudentById(id);
            if (!student) return;
            
            document.getElementById('studentMatricule').value = student.matricule;
            document.getElementById('studentName').value = student.name;
            document.querySelector(`input[name="studentGender"][value="${student.gender}"]`).checked = true;
            document.getElementById('studentClass').value = student.className;
            document.getElementById('studentStatus').value = student.status;
            document.getElementById('totalAmount').value = student.totalAmount;
            document.getElementById('scholarshipType').value = student.scholarshipType || 'Aucune';
            document.getElementById('scholarshipAmount').value = student.scholarshipAmount || 0;
            
            document.querySelector('#add-student-form button[type="submit"]').innerHTML = `<i class="fas fa-save"></i> ${translations[currentLanguage]['edit']}`;
            
            const originalFormSubmit = document.getElementById('add-student-form').onsubmit;

            document.getElementById('add-student-form').onsubmit = (e) => {
                e.preventDefault();
                const data = {
                    matricule: document.getElementById('studentMatricule').value.trim(),
                    name: document.getElementById('studentName').value.trim(),
                    gender: document.querySelector('input[name="studentGender"]:checked')?.value || '',
                    className: document.getElementById('studentClass').value.trim(),
                    status: document.getElementById('studentStatus').value,
                    totalAmount: parseFloat(document.getElementById('totalAmount').value),
                    scholarshipType: document.getElementById('scholarshipType').value,
                    scholarshipAmount: parseFloat(document.getElementById('scholarshipAmount').value)
                };
                if (addOrUpdateStudent(data, id)) {
                    document.getElementById('add-student-form').reset();
                    // Restore original submit handler
                    document.getElementById('add-student-form').onsubmit = originalFormSubmit;
                    document.querySelector('#add-student-form button[type="submit"]').innerHTML = `<i class="fas fa-plus"></i> ${translations[currentLanguage]['add-student']}`;
                }
            };
        }

        function openPaymentModal(id) {
            const student = getStudentById(id);
            if (!student) return;
            
            document.getElementById('modalStudentId').value = student.id;
            document.getElementById('modalStudentName').value = student.name;
            
            const balance = student.totalAmount - student.amountPaid;
            document.getElementById('modalRemainingBalance').textContent = formatCurrency(balance);
            document.getElementById('paymentAmount').max = balance;
            document.getElementById('paymentAmount').value = balance > 0 ? balance : 0;
            
            document.getElementById('payment-form').reset();
            document.getElementById('recordPaymentBtn').style.display = 'inline-flex';
            document.getElementById('printReceiptBtn').style.display = 'none';
            document.getElementById('modal-message').style.display = 'none';
            
            document.getElementById('paymentModal').style.display = 'flex';
        }

        // === PAYMENT FUNCTIONS ===
        function handlePaymentFormSubmit(e) {
            e.preventDefault();
            const studentId = parseInt(document.getElementById('modalStudentId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const types = Array.from(document.querySelectorAll('input[name="paymentType"]:checked')).map(cb => cb.value);
            const categories = Array.from(document.querySelectorAll('input[name="feeCategory"]:checked')).map(cb => cb.value);
            const nextDate = document.getElementById('paymentDate').value;

            if (types.length === 0) {
                showMessage(document.getElementById('modal-message'), translations[currentLanguage]['error-select-payment-type'], 'error');
                return;
            }
            if (categories.length === 0) {
                showMessage(document.getElementById('modal-message'), translations[currentLanguage]['error-select-fee-category'], 'error');
                return;
            }

            const school = getSchoolData();
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            const remaining = student.totalAmount - student.amountPaid;
            
            if (!student || !amount || amount <= 0 || amount > remaining) {
                showMessage(document.getElementById('modal-message'), translations[currentLanguage]['error-invalid-amount'], 'error');
                return;
            }

            student.amountPaid += amount;
            const payment = {
                id: Date.now(),
                studentId,
                matricule: student.matricule,
                name: student.name,
                className: student.className,
                amount,
                date: new Date().toISOString(),
                reference: document.getElementById('paymentRef').value.trim(),
                paymentType: types.join(', '),
                feeCategory: categories.join(', '),
                cashierName: school.settings.signatureName,
                cashierTitle: school.settings.signatureTitle,
                nextPaymentDate: nextDate,
                receiptSnapshot: {
                    schoolName: school.settings.schoolName,
                    schoolPhone: school.settings.schoolPhone,
                    schoolAddress: school.settings.schoolAddress,
                    schoolLogo: school.settings.schoolLogo,
                    remainingBalance: student.totalAmount - student.amountPaid,
                    amountPaidBefore: student.amountPaid - amount // Correct amount paid before this transaction
                }
            };
            
            if (!yearData.payments) yearData.payments = [];
            yearData.payments.push(payment);
            saveData();
            showMessage(document.getElementById('modal-message'), translations[currentLanguage]['payment-recorded-success'], 'success');
            
            // Update modal UI after successful payment
            document.getElementById('modalRemainingBalance').textContent = formatCurrency(payment.receiptSnapshot.remainingBalance);
            document.getElementById('recordPaymentBtn').style.display = 'none';
            document.getElementById('printReceiptBtn').style.display = 'inline-flex';
            document.getElementById('printReceiptBtn').onclick = () => printPaymentReceipt(payment);
            
            updateAllDisplays();
        }

        function deletePayment(paymentId, studentId, amount) {
            if (!confirm(translations[currentLanguage]['confirm-delete-payment'])) return;
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            
            if (student) student.amountPaid -= amount;
            
            yearData.payments = yearData.payments.filter(p => p.id !== paymentId);
            saveData();
            showMessage(document.getElementById('payment-message'), translations[currentLanguage]['payment-deleted-success'], 'success');
            renderPaymentHistory(paymentCurrentPage);
            updateAllDisplays();
        }

        function renderPaymentHistory(page = 1) {
            const yearData = getSchoolYearData();
            const selectedClass = document.getElementById('classFilter').value;
            let filtered = selectedClass ? yearData.payments.filter(p => p.className === selectedClass) : [...(yearData.payments || [])];
            
            // Sorting and Pagination logic
            filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
            const totalPages = Math.ceil(filtered.length / PAYMENTS_PER_PAGE);
            paymentCurrentPage = Math.min(Math.max(1, page), totalPages || 1);
            const start = (paymentCurrentPage - 1) * PAYMENTS_PER_PAGE;
            const paginated = filtered.slice(start, start + PAYMENTS_PER_PAGE);

            const tbody = document.querySelector('#payment-table tbody');
            tbody.innerHTML = '';
            
            if (paginated.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" style="text-align: center;">${translations[currentLanguage]['no-payments-found']}</td></tr>`;
            } else {
                paginated.forEach(payment => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(payment.date).toLocaleDateString('fr-FR')}</td>
                        <td>${payment.matricule}</td>
                        <td>${payment.name}</td>
                        <td>${payment.className}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${payment.paymentType}</td>
                        <td>${payment.feeCategory}</td>
                        <td>${payment.reference || 'N/A'}</td>
                        <td>
                            <button class="btn btn-small" onclick="printPaymentReceipt(${payment.id})"><i class="fas fa-print"></i></button>
                            <button class="btn btn-small btn-danger" onclick="deletePayment(${payment.id}, ${payment.studentId}, ${payment.amount})"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            }
            
            // Update pagination UI
            document.getElementById('currentPagePayment').textContent = paymentCurrentPage;
            document.getElementById('totalPagesPayment').textContent = totalPages;
            document.getElementById('prevPaymentBtn').disabled = paymentCurrentPage === 1;
            document.getElementById('nextPaymentBtn').disabled = paymentCurrentPage === totalPages || totalPages === 0;
            
            // Add listeners for pagination buttons
            document.getElementById('prevPaymentBtn').onclick = () => renderPaymentHistory(paymentCurrentPage - 1);
            document.getElementById('nextPaymentBtn').onclick = () => renderPaymentHistory(paymentCurrentPage + 1);
            
            // Add listener for class filter change
            document.getElementById('classFilter').onchange = () => renderPaymentHistory(1);
        }

        function printPaymentReceipt(paymentId) {
            const yearData = getSchoolYearData();
            const payment = yearData.payments.find(p => p.id === paymentId);
            if (!payment) return;
            const { jsPDF } = window.jspdf;
            
            // A5 landscape dimensions in points (148mm x 210mm approx 420 x 595.3 points)
            const doc = new jsPDF({ unit: 'mm', format: 'a5', orientation: 'landscape' });
            const settings = payment.receiptSnapshot || getSchoolData().settings;
            
            const receiptTemplate = `
                <div class="printable-area receipt-half-a4">
                    <div class="receipt">
                        <div class="receipt-header-top">
                            <div class="receipt-logo-container">
                                ${settings.schoolLogo ? `<img src="${settings.schoolLogo}" alt="Logo" class="receipt-logo">` : `<div class="receipt-logo placeholder">[ LOGO ]</div>`}
                            </div>
                            <div class="receipt-school-details">
                                <p class="receipt-school-name">${settings.schoolName.toUpperCase()}</p>
                                <p class="receipt-school-contact">Tél: ${settings.schoolPhone} | Adresse: ${settings.schoolAddress}</p>
                                <p style="font-size: 1.2em; font-weight: bold; margin-top: 10px;">REÇU DE PAIEMENT N°${payment.id}</p>
                            </div>
                        </div>

                        <hr class="receipt-divider-line">

                        <div class="receipt-content-grid" style="grid-template-columns: 2fr 2fr;">
                            <div class="receipt-left-column">
                                <p><span class="label">Matricule:</span> <strong>${payment.matricule}</strong></p>
                                <p><span class="label">Élève:</span> <strong>${payment.name}</strong></p>
                                <p><span class="label">Classe:</span> <strong>${payment.className}</strong></p>
                                <p><span class="label">Date Paiement:</span> <strong>${new Date(payment.date).toLocaleDateString('fr-FR')}</strong></p>
                            </div>
                            <div class="receipt-center-column">
                                <div class="amount-box">
                                    <span class="label">Montant Payé</span>
                                    <span class="amount-value">${formatCurrency(payment.amount)}</span>
                                </div>
                                <div class="amount-box" style="background-color: #f0f0f0;">
                                    <span class="label">Nouveau Solde Restant</span>
                                    <span class="amount-value">${formatCurrency(payment.receiptSnapshot.remainingBalance)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <p style="margin-top: 10px;"><span class="label">Nature du Paiement:</span> <strong>${payment.feeCategory}</strong></p>
                        <p><span class="label">Mode de Paiement:</span> <strong>${payment.paymentType}</strong></p>
                        <p><span class="label">Référence:</span> <strong>${payment.reference || 'N/A'}</strong></p>

                        ${payment.nextPaymentDate ? `<p style="margin-top: 10px; font-weight: bold; color: var(--error-color);">Prochain versement prévu le: ${new Date(payment.nextPaymentDate).toLocaleDateString('fr-FR')}</p>` : ''}
                        
                        <div class="receipt-bottom-grid">
                            <div class="cashier-info">
                                <p class="cashier-name">${payment.cashierName || settings.signatureName}</p>
                                <p class="signature-line">${payment.cashierTitle || settings.signatureTitle}</p>
                            </div>
                            <div class="school-stamp-area">
                                CACHET DE L'ÉTABLISSEMENT
                            </div>
                        </div>

                        <p class="receipt-note">** CE REÇU N'EST VALABLE QU'AVEC LE CACHET DE L'ÉTABLISSEMENT ET LA SIGNATURE DU CAISSIER **</p>
                    </div>
                </div>
            `;
            
            document.getElementById('print-container').innerHTML = receiptTemplate;
            window.print();
            document.getElementById('print-container').innerHTML = ''; // Clear after print
        }


        // === GRADES FUNCTIONS ===
        function renderGradesTable() {
            const yearData = getSchoolYearData();
            const tbody = document.querySelector('#grades-table tbody');
            tbody.innerHTML = '';
            
            if (!yearData.grades || yearData.grades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune note trouvée.</td></tr>';
                return;
            }

            yearData.grades.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(grade => {
                const student = yearData.students.find(s => s.id === grade.studentId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${student ? student.name : 'N/A'}</td>
                    <td>${grade.subject}</td>
                    <td>${grade.type}</td>
                    <td>${grade.value.toFixed(1)}/20</td>
                    <td>${grade.coefficient}</td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteGrade(${grade.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
            });
        }

        function deleteGrade(gradeId) {
            const yearData = getSchoolYearData();
            yearData.grades = yearData.grades.filter(g => g.id !== gradeId);
            saveData();
            renderGradesTable();
        }

        function generateBulletin() {
            const studentId = parseInt(document.getElementById('bulletinStudentSelect').value);
            const term = document.getElementById('bulletinTerm').value;
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Veuillez sélectionner un élève.');
                return;
            }

            const studentGrades = yearData.grades.filter(g => g.studentId === studentId);
            if (studentGrades.length === 0) {
                alert('Aucune note trouvée pour cet élève.');
                return;
            }

            const school = getSchoolData();
            let bulletinHtml = `
                <div class="printable-area sheet">
                    <header class="sheet-header">
                        ${school.settings.schoolLogo ? `<img src="${school.settings.schoolLogo}" alt="Logo" class="sheet-logo">` : `<div class="sheet-logo placeholder">LOGO</div>`}
                        <h2 class="sheet-school-name">${school.settings.schoolName.toUpperCase()}</h2>
                        <p class="sheet-school-contact">${school.settings.schoolAddress} - Tél: ${school.settings.schoolPhone}</p>
                        <h3 class="sheet-title-heading">BULLETIN DE NOTES - ${term} - ${appData.currentSchoolYear}</h3>
                    </header>
                    
                    <div class="sheet-info-line">
                        <p><strong>Élève:</strong> ${student.name}</p>
                        <p><strong>Classe:</strong> ${student.className}</p>
                        <p><strong>Matricule:</strong> ${student.matricule}</p>
                    </div>
                    
                    <table class="sheet-table">
                        <thead>
                            <tr>
                                <th>Matière</th>
                                <th>Type</th>
                                <th>Note</th>
                                <th>Coefficient</th>
                                <th>Note Pondérée</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            let totalWeighted = 0;
            let totalCoeff = 0;

            studentGrades.forEach(grade => {
                const weightedNote = grade.value * grade.coefficient;
                totalWeighted += weightedNote;
                totalCoeff += grade.coefficient;
                
                bulletinHtml += `
                    <tr>
                        <td>${grade.subject}</td>
                        <td>${grade.type}</td>
                        <td>${grade.value.toFixed(1)}/20</td>
                        <td>${grade.coefficient}</td>
                        <td>${weightedNote.toFixed(1)}</td>
                    </tr>
                `;
            });

            const average = totalCoeff > 0 ? (totalWeighted / totalCoeff).toFixed(1) : 0;

            bulletinHtml += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <h4>Moyenne Générale: ${average}/20</h4>
                        <p>Appréciation: ${average >= 16 ? 'Excellent' : average >= 14 ? 'Très bien' : average >= 12 ? 'Bien' : average >= 10 ? 'Assez bien' : 'Insuffisant'}</p>
                    </div>

                    <footer class="sheet-footer">
                        <div class="sheet-signature-area">
                            <p>Le ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p>${school.settings.signatureName}, ${school.settings.signatureTitle}</p>
                            <p>(Signature et Cachet)</p>
                        </div>
                    </footer>
                </div>
            `;

            document.getElementById('print-container').innerHTML = bulletinHtml;
            window.print();
            document.getElementById('print-container').innerHTML = '';
        }

        function sendBulletinByWhatsApp() {
            const studentId = parseInt(document.getElementById('bulletinStudentSelect').value);
            const term = document.getElementById('bulletinTerm').value;
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            
            if (!student) {
                alert('Veuillez sélectionner un élève.');
                return;
            }

            const studentGrades = yearData.grades.filter(g => g.studentId === studentId);
            if (studentGrades.length === 0) {
                alert('Aucune note trouvée pour cet élève.');
                return;
            }

            let totalWeighted = 0;
            let totalCoeff = 0;

            studentGrades.forEach(grade => {
                totalWeighted += grade.value * grade.coefficient;
                totalCoeff += grade.coefficient;
            });

            const average = totalCoeff > 0 ? (totalWeighted / totalCoeff).toFixed(1) : 0;

            const message = `Bulletin de notes de ${student.name} (${term}) - Moyenne: ${average}/20 - ${average >= 10 ? 'Admis' : 'Redoublement conseillé'}`;
            
            // Ouvrir WhatsApp avec le message prérempli
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }

        // === TEACHER FUNCTIONS ===
        function renderTeacherTable() {
            const yearData = getSchoolYearData();
            const tbody = document.querySelector('#teacher-table tbody');
            tbody.innerHTML = '';
            
            if (!yearData.teachers || yearData.teachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucun enseignant trouvé.</td></tr>';
                return;
            }

            yearData.teachers.sort((a,b) => a.name.localeCompare(b.name)).forEach(teacher => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${teacher.name}</td>
                    <td>${teacher.subject}</td>
                    <td>${teacher.className}</td>
                    <td>${teacher.phone || 'N/A'}</td>
                    <td>${formatCurrency(teacher.salary)}</td>
                    <td>
                        <button class="btn btn-small btn-danger" onclick="deleteTeacher(${teacher.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
            });
        }

        function deleteTeacher(teacherId) {
            const yearData = getSchoolYearData();
            yearData.teachers = yearData.teachers.filter(t => t.id !== teacherId);
            saveData();
            renderTeacherTable();
        }

        // === EXPORT FUNCTIONS ===
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const yearData = getSchoolYearData();
            const school = getSchoolData();
            
            doc.setFontSize(16);
            doc.text(`Rapport - ${school.settings.schoolName}`, 20, 20);
            doc.setFontSize(12);
            doc.text(`Année scolaire: ${appData.currentSchoolYear}`, 20, 30);
            doc.text(`Total élèves: ${yearData.students.length}`, 20, 40);
            
            const totalCollected = yearData.students.reduce((sum, s) => sum + s.amountPaid, 0);
            doc.text(`Total collecté: ${formatCurrency(totalCollected)}`, 20, 50);
            
            doc.save('rapport-scolaire.pdf');
        }

        function exportToExcel() {
            const yearData = getSchoolYearData();
            const school = getSchoolData();
            
            const wsData = [
                ['Rapport Scolaire', school.settings.schoolName, `Année: ${appData.currentSchoolYear}`],
                [],
                ['Matricule', 'Nom', 'Classe', 'Genre', 'Statut', 'Total Dû', 'Payé', 'Solde']
            ];
            
            yearData.students.forEach(student => {
                wsData.push([
                    student.matricule,
                    student.name,
                    student.className,
                    student.gender,
                    student.status,
                    student.totalAmount,
                    student.amountPaid,
                    student.totalAmount - student.amountPaid
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Élèves');
            XLSX.writeFile(wb, 'rapport-eleves.xlsx');
        }

        function exportBackup() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-gestion-scolaire-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            alert(translations[currentLanguage]['backup-success']);
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm('Cette action remplacera toutes les données actuelles. Continuer ?')) {
                            appData = importedData;
                            saveData();
                            loadData();
                            updateAllDisplays();
                            alert(translations[currentLanguage]['restore-success']);
                        }
                    } catch (error) {
                        alert('Erreur lors de la lecture du fichier de sauvegarde.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportInspectionExcel() {
            exportToExcel();
        }

        function generateStudentSheet() {
            generateSheet('student');
        }

        function generateTuitionFeesSheet() {
            generateSheet('tuition');
        }

        function generateClassSheet() {
            generateSheet('class');
        }

        function generateSheet(type) {
            const yearData = getSchoolYearData();
            const school = getSchoolData();
            const students = yearData.students;
            if (students.length === 0) { alert('Aucun élève à exporter.'); return; }
            
            let sheetHtml = '';
            let title = '';

            const headerHtml = `
                <div class="printable-area sheet">
                    <header class="sheet-header">
                        ${school.settings.schoolLogo ? `<img src="${school.settings.schoolLogo}" alt="Logo" class="sheet-logo">` : `<div class="sheet-logo placeholder">LOGO</div>`}
                        <h3 class="sheet-school-name">${school.settings.schoolName.toUpperCase()}</h3>
                        <p class="sheet-school-contact">Tél: ${school.settings.schoolPhone} | Adresse: ${school.settings.schoolAddress}</p>
                        <h4 class="sheet-title-heading"></h4>
                        <p>${translations[currentLanguage]['number-of-students-label']} ${students.length}</p>
                    </header>
                    <hr>
            `;

            if (type === 'student') {
                title = translations[currentLanguage]['student-sheet-title'];
                const tableRowsHtml = students.map((s, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.matricule}</td>
                        <td>${s.name}</td>
                        <td>${s.gender || 'N/A'}</td>
                        <td>${s.className}</td>
                        <td>${s.status}</td>
                        <td>${formatCurrency(s.totalAmount)}</td>
                        <td></td>
                    </tr>
                `).join('');

                sheetHtml = headerHtml + `
                    <h4 class="sheet-title-heading">${title} - ${appData.currentSchoolYear}</h4>
                    <div class="sheet-body">
                        <table class="sheet-table">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Matricule</th>
                                    <th>Nom et Prénoms</th>
                                    <th>Genre</th>
                                    <th>Classe</th>
                                    <th>Statut</th>
                                    <th>Total Dû</th>
                                    <th>Signature Élève/Parent</th>
                                </tr>
                            </thead>
                            <tbody>${tableRowsHtml}</tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="sheet-footer">
                        <div class="sheet-signature-area">
                            <p>Le ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p>${school.settings.signatureName}, ${school.settings.signatureTitle}</p>
                            <p>(Signature et Cachet)</p>
                        </div>
                        <div class="stamp-area">Cachet de l'école</div>
                    </div>
                </div>
                `;
            } else if (type === 'tuition') {
                title = translations[currentLanguage]['tuition-fees-sheet-title'];
                const tableRowsHtml = students.map((s, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.name}</td>
                        <td>${s.className}</td>
                        <td>${formatCurrency(s.totalAmount)}</td>
                        <td>${formatCurrency(s.amountPaid)}</td>
                        <td>${formatCurrency(s.totalAmount - s.amountPaid)}</td>
                        <td>${getPaymentStatus(s)}</td>
                        <td></td>
                    </tr>
                `).join('');

                sheetHtml = headerHtml + `
                    <h4 class="sheet-title-heading">${title} - ${appData.currentSchoolYear}</h4>
                    <div class="sheet-body">
                        <table class="sheet-table">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Nom et Prénoms</th>
                                    <th>Classe</th>
                                    <th>${translations[currentLanguage]['total-due-label']}</th>
                                    <th>${translations[currentLanguage]['total-paid-label']}</th>
                                    <th>${translations[currentLanguage]['remaining-balance-label']}</th>
                                    <th>Statut</th>
                                    <th>Observations</th>
                                </tr>
                            </thead>
                            <tbody>${tableRowsHtml}</tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="sheet-footer">
                        <div class="sheet-signature-area">
                            <p>Le ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p>${school.settings.signatureName}, ${school.settings.signatureTitle}</p>
                            <p>(Signature et Cachet)</p>
                        </div>
                        <div class="stamp-area">Cachet de l'école</div>
                    </div>
                </div>
                `;
            } else if (type === 'class') {
                title = translations[currentLanguage]['class-sheet-title'];
                const tableRowsHtml = students.map((s, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${s.matricule}</td>
                        <td>${s.name}</td>
                        <td>${s.gender || 'N/A'}</td>
                        <td>${s.status}</td>
                        <td></td>
                    </tr>
                `).join('');

                sheetHtml = headerHtml + `
                    <h4 class="sheet-title-heading">${title} - ${appData.currentSchoolYear}</h4>
                    <div class="sheet-body">
                        <table class="sheet-table">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Matricule</th>
                                    <th>Nom et Prénoms</th>
                                    <th>Genre</th>
                                    <th>Statut</th>
                                    <th>Signature / Remarque</th>
                                </tr>
                            </thead>
                            <tbody>${tableRowsHtml}</tbody>
                        </table>
                    </div>
                    <hr>
                    <div class="sheet-footer">
                        <div class="sheet-signature-area">
                            <p>Le ${new Date().toLocaleDateString('fr-FR')}</p>
                            <p>${school.settings.signatureName}, ${school.settings.signatureTitle}</p>
                            <p>(Signature et Cachet)</p>
                        </div>
                        <div class="stamp-area">Cachet de l'école</div>
                    </div>
                </div>
                `;
            }
            
            document.getElementById('print-container').innerHTML = sheetHtml;
            window.print();
            document.getElementById('print-container').innerHTML = '';
        }

        function sendPaymentSMS() {
            const studentId = parseInt(document.getElementById('modalStudentId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            
            if (!student) return;
            
            const message = `Paiement de ${formatCurrency(amount)} reçu pour ${student.name}. Merci!`;
            alert(`SMS à envoyer: ${message}`);
        }

        function sendPaymentWhatsApp() {
            const studentId = parseInt(document.getElementById('modalStudentId').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const yearData = getSchoolYearData();
            const student = yearData.students.find(s => s.id === studentId);
            
            if (!student) return;
            
            const message = `Paiement de ${formatCurrency(amount)} reçu pour ${student.name}. Merci pour votre confiance!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
        }


        // === INITIALIZATION & EVENT LISTENERS ===
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            toggleDarkMode(isDarkMode);
            setLanguage(currentLanguage);

            // Close modal functionality
            document.querySelector('.modal-close-btn').addEventListener('click', () => {
                document.getElementById('paymentModal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === document.getElementById('paymentModal')) {
                    document.getElementById('paymentModal').style.display = 'none';
                }
            });


            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
                    document.getElementById(link.dataset.section).style.display = 'block';
                    
                    // Re-render relevant tables on section change
                    if (link.dataset.section === 'student-section') renderStudentTable(1);
                    if (link.dataset.section === 'payment-section') renderPaymentHistory(1);
                    if (link.dataset.section === 'grades-section') renderGradesTable();
                    if (link.dataset.section === 'teacher-section') renderTeacherTable();
                    if (link.dataset.section === 'stats-section') updateStatsSection();
                });
            });

            // School & Year Select
            document.getElementById('schoolSelect').addEventListener('change', (e) => {
                appData.currentSchool = e.target.value;
                loadData(); // Re-load settings for the new school
                initializeCurrentYear();
                updateAllDisplays();
                document.getElementById('schoolSelect').value = appData.currentSchool; // Ensure correct school is selected in dropdown
            });

            document.getElementById('currentSchoolYearSelect').addEventListener('change', (e) => {
                if (e.target.value === 'new') {
                    const newYearStart = prompt(translations[currentLanguage]['prompt-new-year'], new Date().getFullYear());
                    if (newYearStart && !isNaN(newYearStart)) {
                        const newYearKey = `${newYearStart}-${parseInt(newYearStart) + 1}`;
                        const school = getSchoolData();
                        if (!school.schoolYears[newYearKey]) {
                            school.schoolYears[newYearKey] = { students: [], payments: [], teachers: [], grades: [] };
                            appData.currentSchoolYear = newYearKey;
                            saveData();
                            updateAllDisplays();
                        } else {
                            alert(translations[currentLanguage]['year-exists']);
                        }
                    }
                    e.target.value = appData.currentSchoolYear;
                } else {
                    appData.currentSchoolYear = e.target.value;
                    saveData();
                    updateAllDisplays();
                }
            });

            // Stats year select should trigger stats update
            document.getElementById('statsSchoolYearSelect').addEventListener('change', updateStatsSection);
            document.getElementById('statsClassFilter').addEventListener('change', updateStatsSection);

            // Forms
            document.getElementById('add-student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const data = {
                    matricule: document.getElementById('studentMatricule').value.trim(),
                    name: document.getElementById('studentName').value.trim(),
                    gender: document.querySelector('input[name="studentGender"]:checked')?.value || 'M',
                    className: document.getElementById('studentClass').value.trim(),
                    status: document.getElementById('studentStatus').value,
                    totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                    scholarshipType: document.getElementById('scholarshipType').value,
                    scholarshipAmount: parseFloat(document.getElementById('scholarshipAmount').value) || 0
                };
                if (addOrUpdateStudent(data)) {
                    document.getElementById('add-student-form').reset();
                    // Reset to "Add" mode after success
                    document.getElementById('add-student-form').onsubmit = null; 
                    document.getElementById('add-student-form').addEventListener('submit', arguments.callee); // Re-add self
                    document.querySelector('#add-student-form button[type="submit"]').innerHTML = `<i class="fas fa-plus"></i> ${translations[currentLanguage]['add-student']}`;
                }
            });

            document.getElementById('add-teacher-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const yearData = getSchoolYearData();
                const teacher = {
                    id: Date.now(),
                    name: document.getElementById('teacherName').value.trim(),
                    subject: document.getElementById('teacherSubject').value.trim(),
                    className: document.getElementById('teacherClass').value.trim(),
                    phone: document.getElementById('teacherPhone').value.trim(),
                    salary: parseFloat(document.getElementById('teacherSalary').value) || 0
                };
                if (!yearData.teachers) yearData.teachers = [];
                yearData.teachers.push(teacher);
                saveData();
                renderTeacherTable();
                document.getElementById('add-teacher-form').reset();
                showMessage(document.getElementById('teacher-message'), 'Enseignant ajouté avec succès!', 'success');
            });

            document.getElementById('add-grade-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const yearData = getSchoolYearData();
                const grade = {
                    id: Date.now(),
                    studentId: parseInt(document.getElementById('gradeStudentSelect').value),
                    subject: document.getElementById('gradeSubject').value.trim(),
                    type: document.getElementById('gradeType').value,
                    value: parseFloat(document.getElementById('gradeValue').value),
                    coefficient: parseInt(document.getElementById('gradeCoefficient').value),
                    date: new Date().toISOString()
                };
                if (!yearData.grades) yearData.grades = [];
                yearData.grades.push(grade);
                saveData();
                renderGradesTable();
                document.getElementById('add-grade-form').reset();
                showMessage(document.getElementById('grades-message'), 'Note ajoutée avec succès!', 'success');
            });

            document.getElementById('payment-form').addEventListener('submit', handlePaymentFormSubmit);

            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                const school = getSchoolData();
                school.settings = {
                    ...school.settings,
                    schoolName: document.getElementById('schoolName').value,
                    schoolPhone: document.getElementById('schoolPhone').value,
                    schoolAddress: document.getElementById('schoolAddress').value,
                    signatureName: document.getElementById('signatureName').value,
                    signatureTitle: document.getElementById('signatureTitle').value,
                    schoolYearStartMonth: parseInt(document.getElementById('schoolYearStartMonth').value)
                };
                saveData();
                showMessage(document.getElementById('settings-message'), translations[currentLanguage]['settings-saved-success'], 'success');
                updateAllDisplays();
            });

            // Logo upload
            document.getElementById('schoolLogo').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const school = getSchoolData();
                        school.settings.schoolLogo = ev.target.result;
                        document.getElementById('logoPreview').src = ev.target.result;
                        document.getElementById('logoPreview').style.display = 'block';
                        document.getElementById('logoPlaceholder').style.display = 'none';
                        saveData();
                        updateAllDisplays();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // CSV import
            document.getElementById('dropZoneImportStudents').addEventListener('click', () => document.getElementById('importStudentsCsv').click());
            document.getElementById('importStudentsCsv').addEventListener('change', (e) => {
                if (e.target.files.length) handleCSVFile(e.target.files[0]);
            });

            // Dark mode
            document.getElementById('darkModeToggle').addEventListener('change', (e) => toggleDarkMode(e.target.checked));

            // Language
            document.getElementById('languageSelect').addEventListener('change', (e) => setLanguage(e.target.value));

            // Initial load data for settings section
            const school = getSchoolData();
            document.getElementById('schoolName').value = school.settings.schoolName;
            document.getElementById('schoolPhone').value = school.settings.schoolPhone;
            document.getElementById('schoolAddress').value = school.settings.schoolAddress;
            document.getElementById('signatureName').value = school.settings.signatureName;
            document.getElementById('signatureTitle').value = school.settings.signatureTitle;
            document.getElementById('schoolYearStartMonth').value = school.settings.schoolYearStartMonth;


            // Final initialization calls
            updateAllDisplays();
            // Simulate a click on the dashboard to show it initially
            document.querySelector('.nav-link[data-section="dashboard-section"]').click();
        });
    </script>
</body>
</html>
